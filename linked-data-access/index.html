<!DOCTYPE html>
<html>
    <head>
        <title>API Example</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script type="text/javascript">
            var endpoint = "http://dbpedia.org/sparql?format=application%2Fsparql-results%2Bjson&CXML_redir_for_subjs=121&CXML_redir_for_hrefs=&timeout=30000&debug=on&query=";
            var queryPart1 = "SELECT ?city ?population WHERE { ?city rdfs:label '";
            var queryPart3 = "'@en. ?city <http://dbpedia.org/ontology/populationTotal> ?population} LIMIT 10";
            var accessToken = "845fd3a89eba4ede94d90cd74825d007";
            var baseUrl = "https://api.api.ai/v1/";

            $(document).ready(function () {
                $("#input").keypress(function (event) {
                    if (event.which === 13) {
                        event.preventDefault();
                        send();
                    }
                });
                $("#rec").click(function (event) {
                    switchRecognition();
                });
            });

            var recognition;
            var synth;

            function startRecognition() {
                recognition = new webkitSpeechRecognition();
                recognition.onstart = function (event) {
                    updateRec();
                };
                recognition.onresult = function (event) {
                    var text = "";
                    for (var i = event.resultIndex; i < event.results.length; ++i) {
                        text += event.results[i][0].transcript;
                    }
                    setInput(text);
                    stopRecognition();
                };
                recognition.onend = function () {
                    stopRecognition();
                };
                recognition.lang = "en-US";
                recognition.start();
            }

            function stopRecognition() {
                if (recognition) {
                    recognition.stop();
                    recognition = null;
                }
                updateRec();
            }

            function switchRecognition() {
                if (recognition) {
                    stopRecognition();
                } else {
                    startRecognition();
                }
            }

            function setInput(text) {
                $("#input").val(text);
                send();
            }

            function updateRec() {
                $("#rec").text(recognition ? "Stop" : "Speak");
            }

            function send() {
                var text = $("#input").val();
                $.ajax({
                    type: "POST",
                    url: baseUrl + "query?v=20150910",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    headers: {
                        "Authorization": "Bearer " + accessToken
                    },
                    data: JSON.stringify({query: text, lang: "en", sessionId: "somerandomthing"}),
                    success: function (data) {
                        //setResponse(JSON.stringify(data, undefined, 2));
                        setResponse(data);
                    },
                    error: function () {
                        setResponse("Internal Server Error");
                    }
                });
                setResponse("Loading...");
            }

            function setResponse(val) {
                console.log(val);
                var queryPart2 = val.result.parameters.city;
                //console.log(val.result.parameters.city);
                var queryComplete = queryPart1 + queryPart2 + queryPart3;
                console.log(queryComplete);
                $.ajax({
                    type: 'POST',
                    url: endpoint + queryComplete,
                    async: true,
                    headers: {
                    }
                })
                        .done(function (result) {
                            if (result.results.bindings[0]) {
                                var bindings = result.results.bindings;
                                var output = bindings[0].population.value;
                                console.log(output);
                                var outputtext = "The population of " + queryPart2 + " is " + output + ".";
                                $("#response").empty().append(outputtext);
                                synth = window.speechSynthesis;
                                var utterThis = new SpeechSynthesisUtterance(outputtext);
                                utterThis.lang = "en-US";
                                synth.speak(utterThis);
                            } else
                                $("#response").empty().append("I don't know the population of this place.");
                        })
                        .fail(function (xhr, statusText, err) {
                            console.log("error");
                            error(xhr + statusText + err);
                            console.log(xhr + statusText);
                        });
            }

        </script>
        <style type="text/css">
            body { width: 500px; margin: 0 auto; text-align: center; margin-top: 20px; }
            div#inputoutput {  position: absolute; }
            input { width: 400px; }
            button { width: 50px; }
            textarea { width: 100%; }
        </style>
    </head>
    <body>
        <h1>Get information from linked data</h1>
        <p>Ask questions to DBpedia. You will get a response below. Works only with Chrome browser because of text-to-speech / speech-to-text functions.</p>
        <div id="inputoutput">
            <input id="input" type="text"> <button id="rec">Speak</button>
            <br>Response<br> <textarea id="response" cols="40" rows="20"></textarea>
        </div>
    </body>
</html>
