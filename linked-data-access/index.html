<!DOCTYPE html>
<html>
    <head>
        <title>Get information from linked data</title>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
        <script type="text/javascript">
            var processingType = "speech";
            var endpoint = "http://dbpedia.org/sparql?format=application%2Fsparql-results%2Bjson&CXML_redir_for_subjs=121&CXML_redir_for_hrefs=&timeout=30000&debug=on&query=";
            var queries = ["SELECT ?city ?population WHERE { ?city rdfs:label '@@@placeholder@@@'@en. ?city <http://dbpedia.org/ontology/populationTotal> ?population} LIMIT 10" , "SELECT ?birthday WHERE { ?person rdfs:label '@@@placeholder@@@'@en. ?person <http://dbpedia.org/ontology/birthDate> ?birthday } LIMIT 10"];
            var responses = ["The population of @@@placeholder@@@ is @@@output@@@.", "The birthday of @@@placeholder@@@ is @@@output@@@."];
            var outputVariables = ["population", "birthday"];
            var placeholder;
            var accessToken = "845fd3a89eba4ede94d90cd74825d007";
            var baseUrl = "https://api.api.ai/v1/";

String.prototype.replaceAll = function(str1, str2, ignore)
    {
        return this.replace(new RegExp(str1.replace(/([\,\!\\\^\$\{\}\[\]\(\)\.\*\+\?\|\<\>\-\&])/g, function(c) {
            return "\\" + c;
        }), "g" + (ignore ? "i" : "")), str2);
    };
            $(document).ready(function () {
                $("#input").keypress(function (event) {
                    if (event.which === 13) {
                        event.preventDefault();
                        send();
                    }
                });
                $("#rec").click(function (event) {
                    switchRecognition();
                });
            });            

            var recognition;
            var synth;

            function startRecognition() {
                recognition = new webkitSpeechRecognition();
                recognition.onstart = function (event) {
                    updateRec();
                };
                recognition.onresult = function (event) {
                    var text = "";
                    for (var i = event.resultIndex; i < event.results.length; ++i) {
                        text += event.results[i][0].transcript;
                    }
                    setInput(text);
                    stopRecognition();
                };
                recognition.onend = function () {
                    stopRecognition();
                };
                recognition.lang = "en-US";
                recognition.start();
            }

            function stopRecognition() {
                if (recognition) {
                    recognition.stop();
                    recognition = null;
                }
                updateRec();
            }

            function switchRecognition() {
                if (recognition) {
                    stopRecognition();
                } else {
                    startRecognition();
                }
            }

            function setInput(text) {
                $("#input").val(text);
                send();
            }

            function updateRec() {
                $("#rec").text(recognition ? "Stop" : "Speak");
            }

            function send() {
                var text = $("#input").val();
                $.ajax({
                    type: "POST",
                    url: baseUrl + "query?v=20150910",
                    contentType: "application/json; charset=utf-8",
                    dataType: "json",
                    headers: {
                        "Authorization": "Bearer " + accessToken
                    },
                    data: JSON.stringify({query: text, lang: "en", sessionId: "somerandomthing"}),
                    success: function (data) {
                        //setResponse(JSON.stringify(data, undefined, 2));
                        setResponse(data);
                    },
                    error: function () {
                        setResponse("Internal Server Error");
                    }
                });
                setResponse("Loading...");
            }

            function setResponse(val) {
                var intentNum;
                var output;
                console.log(val);
                if(val.result.parameters.city) {intentNum = 0; placeholder = val.result.parameters.city;} else
                    {intentNum = 1; placeholder = val.result.parameters.givenname + " " + val.result.parameters.lastname;};
                console.log("placeholder now :" + placeholder);
                var queryComplete = queries[intentNum].replaceAll("@@@placeholder@@@",placeholder);
                console.log(queryComplete);
                $.ajax({
                    type: 'POST',
                    url: endpoint + queryComplete,
                    async: true,
                    headers: {
                    }
                })
                        .done(function (result) {
                            if (result.results.bindings[0]) {
                                var bindings = result.results.bindings;
                                output = bindings[0][outputVariables[intentNum]].value;
                                console.log(output);
                                var outputtext1 = responses[intentNum].replace("@@@placeholder@@@", placeholder);
                                var outputtext2 = outputtext1.replace("@@@output@@@", output);
                                $("#response").empty().append(outputtext2 +  "\nThe query used for this output was:\n" + queryComplete);
//                                if (processingType === "speech") {
//                                synth = window.speechSynthesis;
//                                var utterThis = new SpeechSynthesisUtterance(outputtext2);
//                                utterThis.lang = "en-US";
//                                synth.speak(utterThis);
//                                ("#response").empty().append(processingType);
//                                };
                            } else
                                $("#response").empty().append("I don't know the answer to your question.");
                        })
                        .fail(function (xhr, statusText, err) {
                            console.log("error");
                            error(xhr + statusText + err);
                            console.log(xhr + statusText);
                        });
            }

        </script>
        <style type="text/css">
            body { width: 500px; margin: 0 auto; text-align: center; margin-top: 20px; }
            div#inputoutput {  position: absolute; }
            input { width: 400px; }
            button { width: 150px; }
            textarea { width: 100%; }
        </style>
    </head>
    <body>
        <h1>Get information from linked data</h1>
        <p>Ask questions to DBpedia. Currently you can ask about the birthday of people and the population of places - more to follow! You will get a response below. The speech input only works with the Chrome browser.</p>
        <div id="inputoutput">
            <input id="input" type="text"> <br><button id="text" onclick="processingType === 'text'; send();">Submit text</button> OR <button id="rec">Start speech input</button> 
            <br>Response<br> <textarea id="response" cols="40" rows="20"></textarea>
        </div>
    </body>
</html>
